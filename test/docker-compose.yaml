version: "3"

services:
  nginx-s3-gateway:
    # If minio client is up and running properly, we are reasonably sure that
    # minio has properly started. That's why we depend on it here.
    depends_on:
      minio:
        condition: service_healthy
    image: "nginx-s3-gateway"
    ports:
      - "8989:${NGINX_INTERNAL_PORT-80}/tcp"
    links:
      - "minio"
    restart: "no"
    environment:
      S3_BUCKET_NAME: "bucket-1"
      S3_ACCESS_KEY_ID: "AKIAIOSFODNN7EXAMPLE"
      S3_SECRET_KEY: "wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY"
      S3_SESSION_TOKEN: "IQoJb3JpZ2luX2VjENj//////////wEaCXVzLWVhc3QtMSJHMEUCIBRc0lQ4uFoTs20HjBk2Wg4vIbOJxjzJkF51ZfBU0x9UAiEAzjVPRL3eUbdO9srmyxWtZAzTrQmRX6wqUx25WKdFt/AqjQMIgP//////////ARACGgw2NDEyMjIyMzAxNTEiDNEZjlhjJ1a1Az38pSrhAo2vDQaBhqZgQfqIuWl0bDWhapJ+sWtwLq3+52S/QtBYuiH9LViOd8T6TmCel0x/qmWGYrwWrQdLy/7qtfxvQBgYw9uHuU2pBd5+3LzMSZ9iKpAKwYZxHzEqJvyiRVTUPZIjZGZnXdDj67uEHWBQcCwI8iacbApoUvMRFu5Elk03CsZosG6JXaEkLkNrIoeXezGqVBTrXsI48wukwFcuYgxPhq8c7t29GMznby7HHCk5yq8x5efr7IM8bomoVRqZFwTniQO579p6SuS4p8FysLmKk5qAcUqOeZhuSft3d7ZwKkvwWxg+NeaLW8aLbgnyCHtfXiLrTAnGZz/kBp9w1mBV2r79z8kvsZNFhESKTFdyJH3g6u5NMcOIuWcW76hg7ta7dzQsTAq87us9NIF0ixTQp7Q3bTrApgCgS9UdD/J2auo1kIr1jbLFqnHHufeEVU16E2EoBGlDe2BWCIE/ZbXkMKiX+p8GOqYBwoBegltHoRH8+Mskgnaef5DSpq5eI5hBG3iuOcp2H0zim3bsBO54joOfW/BfBhq/6cXsTf53F207C+VAHwDJW507bd9GDbWsU2JBsmGnloGAeoArNsGORHkWaGTV90bVDu6p9T8BDR2Z8zYPXb/poK02euPW008CQhxbpvrREztIR3M3+d0CBdkchcC2Y9pVN00byh22fSZZSDv5Scuo3F3ijZEyPA=="
      S3_SERVER: "minio"
      S3_SERVER_PORT: "9000"
      S3_SERVER_PROTO: "http"
      S3_REGION: "us-east-1"
      S3_DEBUG: "true"
      S3_STYLE: "virtual"
      ALLOW_DIRECTORY_LIST:
      PROVIDE_INDEX_PAGE:
      APPEND_SLASH_FOR_POSSIBLE_DIRECTORY:
      AWS_SIGS_VERSION:
      STATIC_SITE_HOSTING:
      PROXY_CACHE_VALID_OK: "1h"
      PROXY_CACHE_VALID_NOTFOUND: "1m"
      PROXY_CACHE_VALID_FORBIDDEN: "30s"

  minio:
    image: "minio/minio:RELEASE.2021-02-19T04-38-02Z"
    ports:
      - "9090:9000/tcp"
    restart: "no"
    command: "server --address :9000 /data"
    environment:
      MINIO_ACCESS_KEY: "AKIAIOSFODNN7EXAMPLE"
      MINIO_SECRET_KEY: "wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY"
      MINIO_REGION_NAME: "us-east-1"
      MINIO_DOMAIN: "minio"
      MINIO_BROWSER: "off"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 5s
      timeout: 3s
      retries: 3
  # It may be useful to enable minio client so that you can debug what calls
  # were made to minio by the gateway.
#  minio-client:
#    depends_on:
#      - "minio"
#    image: "minio/mc"
#    restart: "no"
#    command: "admin trace --verbose nginx-test-gateway"
#    environment:
#      MC_HOST_nginx-test-gateway: "http://AKIAIOSFODNN7EXAMPLE:wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY@minio:9000"
